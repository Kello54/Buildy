<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Buildy - Core Data Handling</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- SheetJS for Excel export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --accent:#0b5cff;
      --muted:#666;
      --success:#1fa05a;
      --danger:#e04b4b;
    }
    body{
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg,#eef3ff 0%, var(--bg) 100%);
      margin:0;
      padding:24px;
      color:#0b1733;
    }
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:18px;
    }
    header h1{ margin:0; font-size:20px; }
    .layout{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:18px;
    }
    .card{
      background:var(--card);
      border-radius:10px;
      box-shadow:0 6px 18px rgba(12,24,60,0.06);
      padding:14px;
    }
    form .row{ display:flex; gap:8px; margin-bottom:8px; }
    label{ font-size:12px; color:var(--muted) }
    input[type="text"], input[type="number"], input[type="date"], select{
      width:100%;
      padding:8px 10px;
      border-radius:6px;
      border:1px solid #e3e6ee;
      font-size:14px;
      background:transparent;
    }
    button{
      padding:8px 12px;
      border-radius:8px;
      border:0;
      cursor:pointer;
      background:var(--accent);
      color:white;
      font-weight:600;
    }
    button.ghost{ background:transparent; color:var(--accent); border:1px solid #e4e9ff; }
    .small{ padding:6px 8px; font-size:13px; }
    table{ width:100%; border-collapse:collapse; font-size:13px; margin-top:10px; }
    thead th{ text-align:left; padding:8px 6px; color:var(--muted); font-weight:600; border-bottom:1px solid #eef1f8; }
    tbody td{ padding:8px 6px; vertical-align:middle; border-bottom:1px solid #f2f5fb; }
    .actions button{ margin-right:6px; }
    .muted{ color:var(--muted); font-size:13px; }
    .suppliers{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .supplier-card{
      display:flex; align-items:center; gap:8px;
      padding:6px 8px; border-radius:8px; border:1px solid #eef2ff; cursor:pointer;
      background:linear-gradient(180deg,#fff 0%, #fbfdff 100%);
    }
    .supplier-card img{ width:36px; height:26px; object-fit:contain; }
    .pill{ display:inline-block; padding:6px 8px; border-radius:999px; background:#f4f7ff; color:var(--muted); font-size:13px; }
    .comparison-table td.cheapest{ background: #e6f7ea; color:var(--success); font-weight:700; }
    .controls{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:8px; }
    .chart-wrap{ padding:6px; }
    @media (max-width:1000px){
      .layout{ grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Buildy - Core Data (local demo)</h1>
      <div class="muted">Add / update material prices • compare • trends • export</div>
    </div>
    <div>
      <button id="clearAll" class="small ghost">Clear all data</button>
    </div>
  </header>

  <div class="layout">
    <!-- LEFT: Form / Suppliers -->
    <div class="card" id="leftCol">
      <h3 style="margin-top:0">Add / Update Material Price</h3>
      <form id="priceForm">
        <input type="hidden" id="entryId" value="" />
        <div class="row">
          <div style="flex:1">
            <label>Material</label>
            <input id="material" type="text" placeholder="e.g. Cement 25kg, Sand (bulk)" required />
          </div>
          <div style="width:140px">
            <label>Supplier</label>
            <select id="supplier" required></select>
          </div>
        </div>

        <div class="row">
          <div style="flex:1">
            <label>Price (numeric)</label>
            <input id="price" type="number" step="0.01" min="0" placeholder="e.g. 12.50" required />
          </div>
          <div style="width:140px">
            <label>Date</label>
            <input id="date" type="date" />
          </div>
        </div>

        <div style="display:flex; gap:8px; margin-top:6px;">
          <button id="saveBtn" type="submit">Save</button>
          <button id="cancelEdit" type="button" class="ghost small">Cancel</button>
          <div style="flex:1"></div>
          <div class="muted" id="formNote">Duplicates prevented for same material+supplier.</div>
        </div>
      </form>

      <hr style="margin:12px 0" />

      <h4 style="margin:6px 0">All Suppliers</h4>
      <div id="suppliersList" class="suppliers"></div>

      <h4 style="margin-top:12px">Quick Stats</h4>
      <div class="muted" id="statsArea"></div>
    </div>

    <!-- RIGHT: Main area (Table, Filters, Comparison, Trends) -->
    <div>
      <div class="card" style="margin-bottom:12px;">
        <div style="display:flex; align-items:center; justify-content:space-between;">
          <div>
            <h3 style="margin:0">Price Entries</h3>
            <div class="muted">Manage and filter entries (saved to localStorage)</div>
          </div>
          <div style="display:flex; gap:8px; align-items:center;">
            <select id="filterSupplier"><option value="">All suppliers</option></select>
            <select id="filterMaterial"><option value="">All materials</option></select>
            <input id="filterFrom" type="date" />
            <input id="filterTo" type="date" />
            <button id="applyFilter" class="small ghost">Apply</button>
            <button id="resetFilter" class="small ghost">Reset</button>
            <button id="exportExcel" class="small">Export Excel</button>
          </div>
        </div>

        <div style="overflow:auto; margin-top:10px;">
          <table id="entriesTable">
            <thead>
              <tr>
                <th>Material</th>
                <th>Supplier</th>
                <th>Price</th>
                <th>Date</th>
                <th style="width:150px">Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="card" style="margin-bottom:12px;">
        <div style="display:flex; align-items:center; justify-content:space-between;">
          <div>
            <h3 style="margin:0">Price Comparison (cheapest per material)</h3>
            <div class="muted">Shows lowest price for each material across suppliers.</div>
          </div>
          <div>
            <button id="refreshComparison" class="small ghost">Refresh</button>
          </div>
        </div>

        <div style="overflow:auto; margin-top:10px;">
          <table id="comparisonTable" class="comparison-table">
            <thead>
              <tr><th>Material</th><th>Supplier</th><th>Price</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div style="display:flex; align-items:center; justify-content:space-between;">
          <div>
            <h3 style="margin:0">Price Trends</h3>
            <div class="muted">Select material to view price trend over time.</div>
          </div>
          <div style="display:flex; gap:8px; align-items:center;">
            <select id="trendMaterial"><option value="">Choose material</option></select>
            <button id="drawTrend" class="small">Show Trend</button>
          </div>
        </div>

        <div class="chart-wrap">
          <canvas id="trendChart" height="160"></canvas>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* --------------------------
       Sample suppliers (logos as data URIs or placeholder)
       Replace logos with real URLs in your repo if you like
       -------------------------- */
    const SAMPLE_SUPPLIERS = [
      { id: 'chadwicks', name: "Chadwick's", logo: 'https://kello54.github.io/Buildy/docs/images/favicon.png' },
      { id: 'woodies', name: "Woodie's", logo: 'https://kello54.github.io/Buildy/docs/images/favicon.png' },
      { id: 'buckley', name: "Buckley", logo: 'https://kello54.github.io/Buildy/docs/images/favicon.png' },
      { id: 'tjomahony', name: "TJ O'Mahony", logo: 'https://kello54.github.io/Buildy/docs/images/favicon.png' }
    ];

    const LS_KEY = 'buildy_data_v1';

    // DOM refs
    const supplierSelect = document.getElementById('supplier');
    const suppliersList = document.getElementById('suppliersList');
    const entriesTableBody = document.querySelector('#entriesTable tbody');
    const filterSupplier = document.getElementById('filterSupplier');
    const filterMaterial = document.getElementById('filterMaterial');
    const filterFrom = document.getElementById('filterFrom');
    const filterTo = document.getElementById('filterTo');
    const exportExcelBtn = document.getElementById('exportExcel');
    const comparisonBody = document.querySelector('#comparisonTable tbody');
    const trendMaterial = document.getElementById('trendMaterial');
    const trendChartCanvas = document.getElementById('trendChart');
    const statsArea = document.getElementById('statsArea');
    const clearAllBtn = document.getElementById('clearAll');

    // Form
    const form = document.getElementById('priceForm');
    const materialInput = document.getElementById('material');
    const priceInput = document.getElementById('price');
    const dateInput = document.getElementById('date');
    const entryIdInput = document.getElementById('entryId');
    const saveBtn = document.getElementById('saveBtn');
    const cancelEditBtn = document.getElementById('cancelEdit');

    // Filter controls
    const applyFilterBtn = document.getElementById('applyFilter');
    const resetFilterBtn = document.getElementById('resetFilter');

    // Comparison refresh
    const refreshComparisonBtn = document.getElementById('refreshComparison');
    const drawTrendBtn = document.getElementById('drawTrend');

    // In-memory data
    let entries = []; // { id, material, supplierId, price, dateISO }
    let trendChart = null;

    function uid() {
      return 'id-' + Math.random().toString(36).slice(2,9);
    }

    function todayISO(){
      const d = new Date();
      d.setHours(0,0,0,0);
      return d.toISOString().slice(0,10);
    }

    // Init suppliers into selects and supplier list
    function populateSuppliers(){
      supplierSelect.innerHTML = '';
      filterSupplier.innerHTML = '<option value="">All suppliers</option>';
      SAMPLE_SUPPLIERS.forEach(s=>{
        const opt = document.createElement('option');
        opt.value = s.id;
        opt.textContent = s.name;
        supplierSelect.appendChild(opt);

        const opt2 = opt.cloneNode(true);
        filterSupplier.appendChild(opt2);
      });

      suppliersList.innerHTML = '';
      SAMPLE_SUPPLIERS.forEach(s=>{
        const div = document.createElement('div');
        div.className = 'supplier-card';
        div.title = 'Filter by ' + s.name;
        div.dataset.supplier = s.id;
        div.innerHTML = \`
          <img src="\${s.logo}" alt="\${s.name}" />
          <div>
            <div style="font-weight:600; font-size:14px;">\${s.name}</div>
            <div class="muted" style="font-size:12px;">Click to filter</div>
          </div>
        \`;
        div.addEventListener('click', ()=> {
          filterSupplier.value = s.id;
          applyFilter();
        });
        suppliersList.appendChild(div);
      });
    }

    // Load/save
    function saveToStorage(){
      localStorage.setItem(LS_KEY, JSON.stringify(entries));
      updateUI();
    }
    function loadFromStorage(){
      const raw = localStorage.getItem(LS_KEY);
      if(raw){
        try{
          entries = JSON.parse(raw);
        }catch(e){
          entries = [];
        }
      }else{
        // Seed a small sample dataset for demo
        entries = [
          { id: uid(), material: "Cement 25kg", supplierId: "chadwicks", price: 12.30, dateISO: "2025-09-01" },
          { id: uid(), material: "Cement 25kg", supplierId: "woodies", price: 11.80, dateISO: "2025-08-20" },
          { id: uid(), material: "Sand (Bulk)", supplierId: "buckley", price: 55.00, dateISO: "2025-07-13" },
          { id: uid(), material: "Concrete Blocks", supplierId: "tjomahony", price: 1.25, dateISO: "2025-06-30" },
          { id: uid(), material: "Concrete Blocks", supplierId: "woodies", price: 1.10, dateISO: "2025-08-01" },
        ];
        saveToStorage();
      }
    }

    // Utilities: get supplier name
    function supplierName(id){
      const s = SAMPLE_SUPPLIERS.find(x => x.id === id);
      return s ? s.name : id;
    }

    // Render entries table
    function renderEntriesList(filtered = null){
      const dataset = filtered || entries.slice().sort((a,b)=> new Date(b.dateISO) - new Date(a.dateISO));
      entriesTableBody.innerHTML = '';
      dataset.forEach(entry => {
        const tr = document.createElement('tr');
        tr.innerHTML = \`
          <td>\${escapeHtml(entry.material)}</td>
          <td>\${escapeHtml(supplierName(entry.supplierId))}</td>
          <td>\${Number(entry.price).toFixed(2)}</td>
          <td>\${entry.dateISO}</td>
          <td class="actions">
            <button class="small ghost" data-edit="\${entry.id}">Edit</button>
            <button class="small" data-delete="\${entry.id}">Delete</button>
          </td>
        \`;
        entriesTableBody.appendChild(tr);
      });

      // attach handlers
      entriesTableBody.querySelectorAll('[data-edit]').forEach(btn=>{
        btn.addEventListener('click', e=>{
          const id = e.currentTarget.dataset.edit;
          startEdit(id);
        });
      });
      entriesTableBody.querySelectorAll('[data-delete]').forEach(btn=>{
        btn.addEventListener('click', e=>{
          const id = e.currentTarget.dataset.delete;
          if(confirm('Delete this entry?')) {
            entries = entries.filter(x=>x.id !== id);
            saveToStorage();
          }
        });
      });
    }

    // Escape HTML
    function escapeHtml(s){
      if(!s) return '';
      return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    // Start edit
    function startEdit(id){
      const e = entries.find(x=>x.id===id);
      if(!e) return;
      entryIdInput.value = e.id;
      materialInput.value = e.material;
      supplierSelect.value = e.supplierId;
      priceInput.value = e.price;
      dateInput.value = e.dateISO || todayISO();
      saveBtn.textContent = 'Update';
    }
    function cancelEdit(){
      entryIdInput.value = '';
      materialInput.value = '';
      supplierSelect.selectedIndex = 0;
      priceInput.value = '';
      dateInput.value = '';
      saveBtn.textContent = 'Save';
    }

    // Validation & duplicate prevention
    function isDuplicate(material, supplierId, excludeId = null){
      return entries.some(e=>{
        if(excludeId && e.id === excludeId) return false;
        return e.material.trim().toLowerCase() === material.trim().toLowerCase()
               && e.supplierId === supplierId;
      });
    }

    // Form submit
    form.addEventListener('submit', (ev)=>{
      ev.preventDefault();
      const id = entryIdInput.value || null;
      const material = materialInput.value.trim();
      const supplierId = supplierSelect.value;
      const price = parseFloat(priceInput.value);
      const dateISO = dateInput.value || todayISO();

      if(!material || !supplierId || isNaN(price)){
        alert('Please complete material, supplier and numeric price.');
        return;
      }

      if(isDuplicate(material, supplierId, id)){
        alert('An entry for this material & supplier already exists. Edit that entry to change price.');
        return;
      }

      if(id){
        // update
        const target = entries.find(e=>e.id===id);
        if(target){
          target.material = material;
          target.supplierId = supplierId;
          target.price = price;
          target.dateISO = dateISO;
        }
      } else {
        entries.push({ id: uid(), material, supplierId, price, dateISO });
      }
      saveToStorage();
      cancelEdit();
    });

    cancelEditBtn.addEventListener('click', ()=> {
      cancelEdit();
    });

    // Filters
    function buildFilterOptions(){
      // material options
      const mats = [...new Set(entries.map(e=>e.material.trim()))].sort();
      filterMaterial.innerHTML = '<option value="">All materials</option>';
      trendMaterial.innerHTML = '<option value="">Choose material</option>';
      mats.forEach(m=>{
        const o = document.createElement('option'); o.value = m; o.textContent = m; filterMaterial.appendChild(o);
        const o2 = document.createElement('option'); o2.value = m; o2.textContent = m; trendMaterial.appendChild(o2);
      });
    }

    function applyFilter(){
      const sup = filterSupplier.value;
      const mat = filterMaterial.value;
      const from = filterFrom.value;
      const to = filterTo.value;

      let filtered = entries.slice();
      if(sup) filtered = filtered.filter(e => e.supplierId === sup);
      if(mat) filtered = filtered.filter(e => e.material === mat);
      if(from) filtered = filtered.filter(e => e.dateISO >= from);
      if(to) filtered = filtered.filter(e => e.dateISO <= to);

      renderEntriesList(filtered);
      updateStats(filtered);
    }

    applyFilterBtn.addEventListener('click', applyFilter);
    resetFilterBtn.addEventListener('click', ()=>{
      filterSupplier.value = '';
      filterMaterial.value = '';
      filterFrom.value = '';
      filterTo.value = '';
      renderEntriesList();
      updateStats();
    });

    // Export to Excel using SheetJS
    exportExcelBtn.addEventListener('click', ()=>{
      // get currently filtered rows visible
      let rows = Array.from(entriesTableBody.querySelectorAll('tr'));
      if(rows.length === 0){
        alert('No rows to export. Try resetting filters or add data.');
        return;
      }
      // construct data array
      const data = [['Material','Supplier','Price','Date']];
      rows.forEach(tr=>{
        const cols = tr.querySelectorAll('td');
        const row = [cols[0].textContent, cols[1].textContent, parseFloat(cols[2].textContent), cols[3].textContent];
        data.push(row);
      });

      // SheetJS
      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Buildy Prices');
      XLSX.writeFile(wb, 'buildy_prices.xlsx');
    });

    // Comparison: cheapest supplier per material
    function computeComparison(){
      // group by material, find min price
      const byMat = {};
      entries.forEach(e=>{
        const m = e.material.trim();
        if(!byMat[m]) byMat[m] = [];
        byMat[m].push(e);
      });
      // build rows: pick minimum price and the supplier for that price
      const rows = [];
      Object.keys(byMat).sort().forEach(m=>{
        const items = byMat[m];
        // sort by price ascending, earliest date if tie
        items.sort((a,b)=>{
          if(a.price !== b.price) return a.price - b.price;
          return new Date(a.dateISO) - new Date(b.dateISO);
        });
        const winner = items[0];
        rows.push({
          material: m,
          supplierId: winner.supplierId,
          price: winner.price.toFixed(2)
        });
      });
      return rows;
    }

    function renderComparison(){
      const rows = computeComparison();
      comparisonBody.innerHTML = '';
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = \`
          <td>\${escapeHtml(r.material)}</td>
          <td>\${escapeHtml(supplierName(r.supplierId))}</td>
          <td class="cheapest">\${Number(r.price).toFixed(2)}</td>
        \`;
        comparisonBody.appendChild(tr);
      });
    }

    refreshComparisonBtn.addEventListener('click', renderComparison);

    // Trends: draw chart for selected material, grouped by supplier
    function drawTrendForMaterial(material){
      if(!material) {
        if(trendChart){ trendChart.destroy(); trendChart = null; }
        return;
      }
      // gather entries for material, group by supplier
      const filtered = entries.filter(e => e.material === material).sort((a,b)=> new Date(a.dateISO) - new Date(b.dateISO));
      const bySupplier = {};
      filtered.forEach(e=>{
        if(!bySupplier[e.supplierId]) bySupplier[e.supplierId] = [];
        bySupplier[e.supplierId].push(e);
      });

      // Build datasets: for consistent x-axis (dates) merge all dates present
      const allDates = [...new Set(filtered.map(e => e.dateISO))].sort();

      // For each supplier, create data array mapped to allDates (use latest price up to that date)
      const datasets = [];
      Object.keys(bySupplier).forEach(sid=>{
        // sort supplier entries by date
        const arr = bySupplier[sid].slice().sort((a,b)=> new Date(a.dateISO) - new Date(b.dateISO));
        const series = [];
        // for each date in allDates, find latest price as of that date (or null)
        allDates.forEach(d=>{
          // find last entry <= d
          const upTo = arr.filter(x => x.dateISO <= d);
          if(upTo.length === 0) series.push(null);
          else series.push(upTo[upTo.length-1].price);
        });
        // add dataset
        datasets.push({
          label: supplierName(sid),
          data: series,
          fill: false,
          tension: 0.2,
          borderWidth: 2,
          // let Chart.js pick color
        });
      });

      // Create / update chart
      if(trendChart) trendChart.destroy();
      trendChart = new Chart(trendChartCanvas.getContext('2d'), {
        type: 'line',
        data: {
          labels: allDates,
          datasets: datasets
        },
        options: {
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: { position: 'bottom' },
            title: { display: true, text: 'Price trend for: ' + material }
          },
          scales: {
            y: { title: { display:true, text:'Price' } },
            x: { title: { display:true, text:'Date' } }
          }
        }
      });
    }

    drawTrendBtn.addEventListener('click', ()=>{
      const mat = trendMaterial.value;
      if(!mat) { alert('Choose a material from the dropdown'); return; }
      drawTrendForMaterial(mat);
    });

    // Stats area
    function updateStats(filtered = null){
      const data = filtered || entries;
      const total = data.length;
      const materials = new Set(data.map(e=>e.material)).size;
      const suppliers = new Set(data.map(e=>e.supplierId)).size;
      statsArea.innerHTML = \`Entries: <strong>\${total}</strong> • Materials: <strong>\${materials}</strong> • Suppliers: <strong>\${suppliers}</strong>\`;
    }

    // Update all UI pieces
    function updateUI(){
      renderEntriesList();
      buildFilterOptions();
      renderComparison();
      updateStats();
    }

    // Clear all data
    clearAllBtn.addEventListener('click', ()=>{
      if(confirm('Clear all saved Buildy data from localStorage? This cannot be undone.')){
        entries = [];
        saveToStorage();
        localStorage.removeItem(LS_KEY);
        location.reload();
      }
    });

    // Helpers: apply current filter when entries change
    function renderEntriesListAndFiltersAuto(){
      // If there are filter values, keep them when updating table
      if(filterSupplier.value || filterMaterial.value || filterFrom.value || filterTo.value){
        applyFilter();
      } else {
        renderEntriesList();
      }
      buildFilterOptions();
    }

    // Listen for storage updates (if opened in multiple tabs)
    window.addEventListener('storage', (e)=>{
      if(e.key === LS_KEY) loadFromStorage(), updateUI();
    });

    // Initialization
    (function init(){
      populateSuppliers();
      loadFromStorage();
      updateUI();

      // default date to today
      dateInput.value = todayISO();

      // When entries change in-memory, re-render related UI (we call saveToStorage which triggers updateUI)
      // Hook saveToStorage to updateUI explicitly by wrapping it
      const origSave = saveToStorage;
      saveToStorage = function(){
        localStorage.setItem(LS_KEY, JSON.stringify(entries));
        renderEntriesListAndFiltersAuto();
        renderComparison();
        updateStats();
      };

      // initial render after wrapping save
      saveToStorage();

      // quick apply filter shortcut (press Enter on filter material)
      filterMaterial.addEventListener('keydown', e => { if(e.key === 'Enter') applyFilter(); });

      // Basic keyboard shortcuts
      document.addEventListener('keydown', e=>{
        // ctrl+shift+n clears form
        if(e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'n'){ cancelEdit(); materialInput.focus(); }
      });
    })();

    // small note: prevent accidental navigation on unsaved edit (optional)
    window.addEventListener('beforeunload', (e)=>{
      if(entryIdInput.value) {
        e.preventDefault();
        e.returnValue = '';
      }
    });
  </script>
</body>
</html>
