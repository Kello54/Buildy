<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Buildy - Real-Time Price Comparison</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Arial, sans-serif; margin: 20px; background: #f7f7f7; color: #333; }
h1 { text-align: center; color: #4b0082; }
.form-container, .filter-container, .export-container { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 15px; }
input, button, select { padding: 8px; font-size: 1rem; }
button { background: #4b0082; color: white; border: none; cursor: pointer; }
button:hover { background: #6a0dad; }
table { width: 100%; border-collapse: collapse; background: white; overflow-x: auto; display: block; }
th, td { padding: 10px; text-align: center; border: 1px solid #ccc; min-width: 100px; }
th { background: #4b0082; color: white; cursor: pointer; }
td.cheapest { background: #c6f5c6; font-weight: bold; }
td.medium { background: #fff3b0; }
td.expensive { background: #f5c6c6; }
td.total { font-weight: bold; background: #e6e6fa; }
canvas { max-width: 100%; margin-top: 30px; }
@media(max-width: 600px) { th, td { font-size: 0.85rem; min-width: 80px; } .form-container, .filter-container, .export-container { flex-direction: column; align-items: stretch; } }
</style>
</head>
<body>

<h1>Buildy - Real-Time Price Comparison</h1>

<div class="form-container">
  <input type="text" id="materialName" placeholder="Material Name">
  <input type="text" id="supplierName" placeholder="Supplier Name">
  <input type="number" id="price" placeholder="Price" step="0.01">
  <button onclick="addPrice()">Add Price</button>
  <button onclick="fetchWPM33Data()">Fetch Market Prices</button>
</div>

<div class="filter-container">
  <input type="text" id="filterMaterial" placeholder="Filter by Material" oninput="renderTable(); renderChart();">
  <select id="filterSupplier" onchange="renderTable(); renderChart();">
    <option value="">All Suppliers</option>
  </select>
</div>

<div class="export-container">
  <button onclick="exportToExcel()">Export to Excel</button>
</div>

<table id="priceTable">
  <thead>
    <tr id="tableHeader">
      <th onclick="sortBy('material')">Material ðŸ”½</th>
      <th>Cheapest</th>
    </tr>
  </thead>
  <tbody></tbody>
  <tfoot>
    <tr id="totalRow"></tr>
  </tfoot>
</table>

<canvas id="priceChart" height="250"></canvas>

<script>
let materials = [];
let suppliersSet = new Set();
let sortDirection = { material: 'asc' };
let chart;

function addPrice() {
  const material = document.getElementById('materialName').value.trim();
  const supplier = document.getElementById('supplierName').value.trim();
  const price = parseFloat(document.getElementById('price').value);
  if (!material || !supplier || isNaN(price)) { alert("Please fill all fields correctly!"); return; }

  suppliersSet.add(supplier);
  updateSupplierFilter();

  let mat = materials.find(m => m.name.toLowerCase() === material.toLowerCase());
  if (!mat) { mat = { name: material, prices: [], history: [] }; materials.push(mat); }

  const existingPrice = mat.prices.find(p => p.supplier.toLowerCase() === supplier.toLowerCase());
  if (existingPrice) { existingPrice.price = price; } else { mat.prices.push({ supplier, price }); }

  const now = new Date().toLocaleDateString();
  mat.history.push({ supplier, price, date: now });

  document.getElementById('materialName').value = '';
  document.getElementById('supplierName').value = '';
  document.getElementById('price').value = '';

  renderTable(); renderChart();
}

function updateSupplierFilter() {
  const select = document.getElementById('filterSupplier');
  const currentOptions = Array.from(select.options).map(opt => opt.value);
  suppliersSet.forEach(s => { if (!currentOptions.includes(s)) { const option = document.createElement('option'); option.value = s; option.textContent = s; select.appendChild(option); } });
}

async function fetchWPM33Data() {
  try {
    const response = await fetch('https://ws.cso.ie/public/api.restful/PxStat.Data.Cube_API.ReadDataset/WPM33/JSON-stat/2.0/en');
    const data = await response.json();
    const values = data.value;
    const labels = Object.values(data.dimension.MATERIAL.category.label);
    const prices = values.slice(-labels.length);

    labels.forEach((materialName, index) => {
      let mat = materials.find(m => m.name.toLowerCase() === materialName.toLowerCase());
      if (!mat) { mat = { name: materialName, prices: [], history: [] }; materials.push(mat); }

      const supplierName = 'Market Average';
      const priceValue = prices[index];
      const existing = mat.prices.find(p => p.supplier === supplierName);
      if (existing) existing.price = priceValue; else mat.prices.push({ supplier: supplierName, price: priceValue });

      const now = new Date().toLocaleDateString();
      mat.history.push({ supplier: supplierName, price: priceValue, date: now });
      suppliersSet.add(supplierName);
    });

    updateSupplierFilter();
    renderTable(); renderChart();
  } catch (err) { console.error("Error fetching WPM33 data:", err); }
}

function renderTable() {
  const tbody = document.querySelector('#priceTable tbody'); tbody.innerHTML = '';
  const filterMat = document.getElementById('filterMaterial').value.toLowerCase();
  const filterSup = document.getElementById('filterSupplier').value;

  const headerRow = document.getElementById('tableHeader'); headerRow.innerHTML = '<th onclick="sortBy(\'material\')">Material ðŸ”½</th>';
  const suppliers = Array.from(suppliersSet);
  suppliers.forEach(s => { const th = document.createElement('th'); th.textContent = s; headerRow.appendChild(th); });
  const cheapestTh = document.createElement('th'); cheapestTh.textContent = 'Cheapest'; headerRow.appendChild(cheapestTh);

  let filteredMaterials = materials.filter(m => m.name.toLowerCase().includes(filterMat));

  filteredMaterials.forEach(mat => {
    const row = document.createElement('tr'); const nameCell = document.createElement('td'); nameCell.textContent = mat.name; row.appendChild(nameCell);

    let pricesArray = mat.prices.map(p => p.price); let minPrice = Math.min(...pricesArray); let maxPrice = Math.max(...pricesArray);
    let cheapestSupplier = '';

    suppliers.forEach(s => {
      const cell = document.createElement('td'); const priceObj = mat.prices.find(p => p.supplier.toLowerCase() === s.toLowerCase());
      if (priceObj) {
        if (!filterSup || filterSup === s) cell.textContent = `â‚¬${priceObj.price.toFixed(2)}`;
        if (priceObj.price === minPrice) { cell.classList.add('cheapest'); cheapestSupplier = s; }
        else if (priceObj.price === maxPrice) cell.classList.add('expensive');
        else cell.classList.add('medium');
      } else { if (!filterSup || filterSup === s) cell.textContent = '-'; }
      row.appendChild(cell);
    });

    const cheapestCell = document.createElement('td'); cheapestCell.textContent = cheapestSupplier || '-'; if (cheapestSupplier) cheapestCell.classList.add('cheapest'); row.appendChild(cheapestCell);
    tbody.appendChild(row);
  });

  renderTotals(filteredMaterials, suppliers);
}

function renderTotals(materialsList, suppliers) {
  const tfoot = document.getElementById('totalRow'); tfoot.innerHTML = '';
  const totalLabel = document.createElement('td'); totalLabel.textContent = 'Total'; totalLabel.classList.add('total'); tfoot.appendChild(totalLabel);
  suppliers.forEach(s => { const totalCell = document.createElement('td'); let sum = 0; materialsList.forEach(m => { const priceObj = m.prices.find(p => p.supplier.toLowerCase() === s.toLowerCase()); if (priceObj) sum += priceObj.price; }); totalCell.textContent = `â‚¬${sum.toFixed(2)}`; totalCell.classList.add('total'); tfoot.appendChild(totalCell); });
  const emptyCell = document.createElement('td'); emptyCell.textContent = '-'; emptyCell.classList.add('total'); tfoot.appendChild(emptyCell);
}

function sortBy(column) { if (column === 'material') { materials.sort((a, b) => { if (sortDirection.material === 'asc') return a.name.localeCompare(b.name); else return b.name.localeCompare(a.name); }); sortDirection.material = sortDirection.material === 'asc' ? 'desc' : 'asc'; renderTable(); renderChart(); } }

function exportToExcel() {
  const table = document.getElementById('priceTable');
  const wb = XLSX.utils.table_to_book(table, { sheet: "Price Comparison" });
  XLSX.writeFile(wb, 'Buildy_Price_Comparison.xlsx');
}

// Fully dynamic chart with cheapest supplier highlighted (thicker + darker)
function renderChart() {
  const ctx = document.getElementById('priceChart').getContext('2d');
  const filterMat = document.getElementById('filterMaterial').value.toLowerCase();
  const filterSup = document.getElementById('filterSupplier').value;

  const filteredMaterials = materials.filter(m => m.name.toLowerCase().includes(filterMat));
  if (filteredMaterials.length === 0) { if (chart) chart.destroy(); return; }

  let suppliers = new Set();
  filteredMaterials.forEach(mat => {
    mat.prices.forEach(p => { if (!filterSup || p.supplier === filterSup) suppliers.add(p.supplier); });
  });
  suppliers = Array.from(suppliers);

  let allDates = [];
  filteredMaterials.forEach(mat => {
    mat.history.forEach(h => { if (!filterSup || h.supplier === filterSup) { if (!allDates.includes(h.date)) allDates.push(h.date); } });
  });
  allDates.sort((a,b) => new Date(a)-new Date(b));

  const datasets = suppliers.map((s, idx) => {
    const data = allDates.map(date => {
      let priceEntry = null;
      for (let mat of filteredMaterials) {
        const entries = mat.history.filter(h => h.supplier === s && h.date === date);
        if (entries.length) priceEntry = entries[entries.length-1];
      }
      return priceEntry ? priceEntry.price : null;
    });

    // Determine cheapest supplier per date
    const borderWidths = data.map((price, i) => {
      if (price === null) return 2;
      let pricesOnDate = suppliers.map(supp => {
        let pEntry = null;
        for (let mat of filteredMaterials) {
          const e = mat.history.filter(h => h.supplier === supp && h.date === allDates[i]);
          if (e.length) pEntry = e[e.length-1];
        }
        return pEntry ? pEntry.price : Infinity;
      });
      return (price === Math.min(...pricesOnDate)) ? 5 : 2;
    });

    const colors = data.map((price, i) => {
      if (price === null) return `hsl(${idx*60},70%,50%)`;
      let pricesOnDate = suppliers.map(supp => {
        let pEntry = null;
        for (let mat of filteredMaterials) {
          const e = mat.history.filter(h => h.supplier === supp && h.date === allDates[i]);
          if (e.length) pEntry = e[e.length-1];
        }
        return pEntry ? p
