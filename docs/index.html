<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Buildy - No.1 Building Material Price Comparison</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<!-- SheetJS for Excel export -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
/* === GLOBAL === */
:root{
  --bg:#f6f8fb;
  --card:#ffffff;
  --accent:#0b5cff;
  --gold:#d4af37;
  --muted:#666;
  --success:#1fa05a;
  --danger:#e04b4b;
}
body{
  font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  background:url('https://cdn.pixabay.com/photo/2017/08/30/01/05/construction-2699620_1280.jpg') no-repeat center center fixed;
  background-size:cover;
  margin:0; padding:24px;
  color:#0b1733;
}
body::before{
  content:"";position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(255,255,255,0.85);z-index:-1;
}
header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  flex-wrap:wrap;
  gap:12px;
  border-bottom:2px solid var(--gold);
  padding-bottom:12px;
  margin-bottom:18px;
}
header h1{ margin:0; font-size:22px; font-weight:700; color:#0b1733; }
header .sub{ font-size:14px; color:var(--muted); margin-top:2px; }
.layout{
  display:grid;
  grid-template-columns:380px 1fr;
  gap:18px;
}
.card{
  background:var(--card);
  border-radius:10px;
  box-shadow:0 6px 18px rgba(12,24,60,0.06);
  padding:14px;
}
.card h3{ margin-top:0; font-size:18px; border-bottom:1px solid var(--gold); padding-bottom:6px;}
form .row{ display:flex; gap:8px; margin-bottom:8px; }
label{ font-size:12px; color:var(--muted) }
input[type="text"], input[type="number"], input[type="date"], select{
  width:100%;
  padding:8px 10px;
  border-radius:6px;
  border:1px solid #e3e6ee;
  font-size:14px;
  background:transparent;
}
button{
  padding:8px 12px;
  border-radius:8px;
  border:0;
  cursor:pointer;
  background:var(--accent);
  color:white;
  font-weight:600;
  transition:0.2s;
}
button:hover{ opacity:0.9; }
button.ghost{ background:transparent; color:var(--accent); border:1px solid #e4e9ff; }
button.small{ padding:6px 8px; font-size:13px; }
table{ width:100%; border-collapse:collapse; font-size:13px; margin-top:10px; }
thead th{ text-align:left; padding:8px 6px; color:var(--muted); font-weight:600; border-bottom:1px solid #eef1f8; }
tbody td{ padding:8px 6px; vertical-align:middle; border-bottom:1px solid #f2f5fb; }
tbody tr:hover{ background:#f9f9f9; }
.actions button{ margin-right:6px; }
.muted{ color:var(--muted); font-size:13px; }
.suppliers{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
.supplier-card{
  display:flex; align-items:center; gap:8px;
  padding:6px 8px; border-radius:8px; border:1px solid #eef2ff; cursor:pointer;
  background:linear-gradient(180deg,#fff 0%, #fbfdff 100%);
}
.supplier-card img{ width:36px; height:26px; object-fit:contain; }
.comparison-table th, .comparison-table td{text-align:center;}
.comparison-table th img{ display:block; margin:0 auto; max-height:40px; }
.comparison-table td.cheapest{ background: #e6f7ea; color:var(--success); font-weight:700; }
.chart-wrap{ padding:6px; }
#map{ height:300px; border-radius:8px; }
@media (max-width:1000px){
  .layout{ grid-template-columns: 1fr; }
}
.search-bar{ margin-bottom:8px; display:flex; gap:6px; flex-wrap:wrap; }
.search-bar input{ flex:1; }
</style>
</head>
<body>
<header>
  <div>
    <h1>Buildy</h1>
    <div class="sub">No.1 Building Material Price Comparison</div>
  </div>
  <div style="display:flex; gap:8px; flex-wrap:wrap;">
    <button id="importJSON" class="small ghost">Import JSON</button>
    <button id="exportJSON" class="small ghost">Export JSON</button>
    <button id="clearAll" class="small ghost">Clear all</button>
  </div>
</header>

<div class="layout">
  <!-- LEFT -->
  <div class="card">
    <h3>Add / Update Material Price</h3>
    <form id="priceForm">
      <input type="hidden" id="entryId" />
      <div class="row">
        <div style="flex:1">
          <label>Material</label>
          <input id="material" type="text" required />
        </div>
        <div style="width:140px">
          <label>Supplier</label>
          <select id="supplier" required></select>
        </div>
      </div>
      <div class="row">
        <div style="flex:1">
          <label>Price</label>
          <input id="price" type="number" step="0.01" min="0" required />
        </div>
        <div style="width:140px">
          <label>Date</label>
          <input id="date" type="date" />
        </div>
      </div>
      <div style="margin-top:6px;">
        <button id="saveBtn" type="submit">Save</button>
        <button id="cancelEdit" type="button" class="ghost small">Cancel</button>
      </div>
    </form>

    <div class="search-bar">
      <input type="text" id="searchMaterial" placeholder="Search material..." />
      <button id="applySearch" class="small ghost">Search</button>
      <button id="resetSearch" class="small ghost">Reset</button>
    </div>

    <h4>All Suppliers</h4>
    <div id="suppliersList" class="suppliers"></div>
    <h4>Quick Stats</h4>
    <div class="muted" id="statsArea"></div>
  </div>

  <!-- RIGHT -->
  <div>
    <div class="card" style="margin-bottom:12px;">
      <h3>Price Entries</h3>
      <div style="display:flex; gap:6px; flex-wrap:wrap; margin-bottom:8px;">
        <select id="filterSupplier"><option value="">All suppliers</option></select>
        <select id="filterMaterial"><option value="">All materials</option></select>
        <input id="filterFrom" type="date" />
        <input id="filterTo" type="date" />
        <button id="applyFilter" class="small ghost">Apply</button>
        <button id="resetFilter" class="small ghost">Reset</button>
        <button id="exportExcel" class="small">Export Excel</button>
      </div>
      <div style="overflow:auto;">
        <table id="entriesTable">
          <thead><tr><th>Material</th><th>Supplier</th><th>Price</th><th>Date</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="card" style="margin-bottom:12px;">
      <h3>Supplier Comparison</h3>
      <div style="overflow:auto;">
        <table id="comparisonTable" class="comparison-table">
          <thead>
            <tr>
              <th>Material</th>
              <th><img src="https://www.chadwicksgroup.ie/wp-content/uploads/2023/07/Chadwicks-Logo.png" title="Chadwicks"><br>Chadwicks</th>
              <th><img src="https://buckleygroup.ie/wp-content/uploads/2023/06/Buckley-Group-Logo.png" title="Buckley"><br>Buckley</th>
              <th><img src="https://www.woodies.ie/media/wysiwyg/woodies-logo.svg" title="Woodie's"><br>Woodie's</th>
              <th><img src="https://tjomahony.ie/wp-content/uploads/2023/05/TJ-OMahony-Logo.png" title="TJ O'Mahony"><br>TJ O'Mahony</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="card" style="margin-bottom:12px;">
      <h3>Price Trends</h3>
      <div style="margin-bottom:6px;">
        <select id="trendMaterial"><option value="">Choose material</option></select>
        <button id="drawTrend" class="small">Show Trend</button>
      </div>
      <div class="chart-wrap"><canvas id="trendChart" height="160"></canvas></div>
    </div>

    <div class="card">
      <h3>Supplier Map</h3>
      <div id="map"></div>
    </div>
  </div>
</div>

<script>
// Supplier data with coords
const SUPPLIERS = [
  { id:'chadwicks', name:"Chadwick's", lat:53.3498, lng:-6.2603 },
  { id:'woodies', name:"Woodie's", lat:53.3331, lng:-6.2489 },
  { id:'buckley', name:"Buckley", lat:53.3472, lng:-6.2591 },
  { id:'tjomahony', name:"TJ O'Mahony", lat:53.355, lng:-6.27 }
];
const LS_KEY = 'buildy_data_v3';

// Mock API
const api = {
  async get(){ return JSON.parse(localStorage.getItem(LS_KEY)||'[]'); },
  async save(entries){ localStorage.setItem(LS_KEY, JSON.stringify(entries)); return true; },
  async clear(){ localStorage.removeItem(LS_KEY); return true; }
};

let entries = [];

// Elements
const form=document.getElementById('priceForm');
const entryIdInput=document.getElementById('entryId');
const materialInput=document.getElementById('material');
const supplierSelect=document.getElementById('supplier');
const priceInput=document.getElementById('price');
const dateInput=document.getElementById('date');
const saveBtn=document.getElementById('saveBtn');
const cancelEditBtn=document.getElementById('cancelEdit');
const entriesTableBody=document.querySelector('#entriesTable tbody');
const filterSupplier=document.getElementById('filterSupplier');
const filterMaterial=document.getElementById('filterMaterial');
const filterFrom=document.getElementById('filterFrom');
const filterTo=document.getElementById('filterTo');
const applyFilterBtn=document.getElementById('applyFilter');
const resetFilterBtn=document.getElementById('resetFilter');
const exportExcelBtn=document.getElementById('exportExcel');
const comparisonBody=document.querySelector('#comparisonTable tbody');
const trendMaterial=document.getElementById('trendMaterial');
const drawTrendBtn=document.getElementById('drawTrend');
const trendChartCanvas=document.getElementById('trendChart');
const statsArea=document.getElementById('statsArea');
const suppliersList=document.getElementById('suppliersList');
const clearAllBtn=document.getElementById('clearAll');
const exportJSONBtn=document.getElementById('exportJSON');
const importJSONBtn=document.getElementById('importJSON');
const searchInput=document.getElementById('searchMaterial');
const applySearchBtn=document.getElementById('applySearch');
const resetSearchBtn=document.getElementById('resetSearch');

function todayISO(){ return new Date().toISOString().slice(0,10); }
function supplierName(id){ return SUPPLIERS.find(s=>s.id===id)?.name || id; }
function uid(){ return 'id-'+Math.random().toString(36).slice(2,9); }

// Render suppliers dropdown + cards
function renderSuppliers(){
  supplierSelect.innerHTML='';
  filterSupplier.innerHTML='<option value="">All suppliers</option>';
  SUPPLIERS.forEach(s=>{
    let opt=document.createElement('option'); opt.value=s.id; opt.textContent=s.name; supplierSelect.appendChild(opt);
    let card=document.createElement('div'); card.className='supplier-card';
    let img=document.createElement('img'); img.src=`https://via.placeholder.com/36x26.png?text=${s.name[0]}`; // fallback
    img.src=`https://www.google.com/s2/favicons?domain=${s.name.replace(/ /g,'')}.ie`; // optional small favicon
    card.appendChild(img); let span=document.createElement('span'); span.textContent=s.name; card.appendChild(span);
    card.onclick=()=>{ filterSupplier.value=s.id; applyFilter(); };
    suppliersList.appendChild(card);
    filterSupplier.appendChild(opt.cloneNode(true));
  });
}

function renderEntries(list=null){
  const data=list||entries; entriesTableBody.innerHTML='';
  data.forEach(e=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${e.material}</td>
      <td>${supplierName(e.supplierId)}</td>
      <td>${e.price.toFixed(2)}</td>
      <td>${e.dateISO}</td>
      <td>
        <button class="small ghost" onclick="editEntry('${e.id}')">Edit</button>
        <button class="small" onclick="deleteEntry('${e.id}')">Delete</button>
      </td>`;
    entriesTableBody.appendChild(tr);
  });
}

function buildFilters(){
  const mats=[...new Set(entries.map(e=>e.material))].sort();
  filterMaterial.innerHTML='<option value="">All materials</option>';
  trendMaterial.innerHTML='<option value="">Choose material</option>';
  mats.forEach(m=>{ filterMaterial.innerHTML+=`<option>${m}</option>`; trendMaterial.innerHTML+=`<option>${m}</option>`; });
}

function renderComparison(){
  const byMat={};
  entries.forEach(e=>{ (byMat[e.material]=byMat[e.material]||[]).push(e); });
  comparisonBody.innerHTML='';
  Object.keys(byMat).forEach(m=>{
    const row=document.createElement('tr'); row.innerHTML=`<td>${m}</td>`;
    SUPPLIERS.forEach(s=>{
      const entry=byMat[m].find(x=>x.supplierId===s.id);
      if(entry) row.innerHTML+=`<td class="${getCheapest(m,s.id)}">${entry.price.toFixed(2)}</td>`;
      else row.innerHTML+='<td>—</td>';
    });
    comparisonBody.appendChild(row);
  });
}

function getCheapest(material,supplierId){
  const list=entries.filter(e=>e.material===material);
  if(!list.length) return '';
  const min=Math.min(...list.map(e=>e.price));
  const entry=list.find(e=>e.price===min);
  return entry.supplierId===supplierId?'cheapest':'';
}

let trendChart=null;
function renderTrend(mat){
  if(trendChart) trendChart.destroy();
  if(!mat) return;
  const data=entries.filter(e=>e.material===mat).sort((a,b)=>new Date(a.dateISO)-new Date(b.dateISO));
  const dates=[...new Set(data.map(e=>e.dateISO))];
  const bySup={}; data.forEach(e=>(bySup[e.supplierId]=bySup[e.supplierId]||[]).push(e));
  const datasets=[];
  Object.keys(bySup).forEach(sid=>{
    const arr=bySup[sid];
    const series=dates.map(d=>{ const upTo=arr.filter(x=>x.dateISO<=d); return upTo.length?upTo[upTo.length-1].price:null; });
    datasets.push({label:supplierName(sid),data:series,fill:false,tension:0.2});
  });
  trendChart=new Chart(trendChartCanvas.getContext('2d'),{type:'line',data:{labels:dates,datasets},options:{plugins:{legend:{position:'bottom'}}}});
}

function updateStats(data=entries){ statsArea.textContent=`Entries: ${data.length} • Materials: ${new Set(data.map(e=>e.material)).size} • Suppliers: ${new Set(data.map(e=>e.supplierId)).size}`; }

// Actions
form.onsubmit=async e=>{
  e.preventDefault();
  const id=entryIdInput.value||uid();
  const mat=materialInput.value.trim(); const sup=supplierSelect.value;
  const price=parseFloat(priceInput.value); const date=dateInput.value||todayISO();
  if(!mat||!sup||isNaN(price)) return alert("Fill all fields");
  const exists=entries.find(x=>x.material.toLowerCase()===mat.toLowerCase()&&x.supplierId===sup&&x.id!==id);
  if(exists) return alert("Duplicate material+supplier exists");
  const obj={id,material:mat,supplierId:sup,price,dateISO:date};
  const idx=entries.findIndex(x=>x.id===id); if(idx>=0) entries[idx]=obj; else entries.push(obj);
  await api.save(entries); cancelEdit(); refresh();
};
function cancelEdit(){ entryIdInput.value=''; materialInput.value=''; priceInput.value=''; supplierSelect.selectedIndex=0; dateInput.value=todayISO(); saveBtn.textContent='Save'; }
window.editEntry=function(id){ const e=entries.find(x=>x.id===id); if(!e) return; entryIdInput.value=e.id; materialInput.value=e.material; supplierSelect.value=e.supplierId; priceInput.value=e.price; dateInput.value=e.dateISO; saveBtn.textContent='Update'; };
window.deleteEntry=async function(id){ if(!confirm("Delete?")) return; entries=entries.filter(x=>x.id!==id); await api.save(entries); refresh(); };

applyFilterBtn.onclick=()=>{ let data=entries; if(filterSupplier.value) data=data.filter(e=>e.supplierId===filterSupplier.value); if(filterMaterial.value) data=data.filter(e=>e.material===filterMaterial.value); if(filterFrom.value) data=data.filter(e=>e.dateISO>=filterFrom.value); if(filterTo.value) data=data.filter(e=>e.dateISO<=filterTo.value); renderEntries(data); updateStats(data); };
resetFilterBtn.onclick=()=>{ filterSupplier.value='';filterMaterial.value='';filterFrom.value='';filterTo.value=''; refresh(); };

applySearchBtn.onclick=()=>{ const q=searchInput.value.trim().toLowerCase(); if(!q) return refresh(); const data=entries.filter(e=>e.material.toLowerCase().includes(q)); renderEntries(data); updateStats(data); };
resetSearchBtn.onclick=()=>{ searchInput.value=''; refresh(); };

exportExcelBtn.onclick=()=>{
  const data=[["Material","Supplier","Price","Date"]]; entries.forEach(e=>data.push([e.material,supplierName(e.supplierId),e.price,e.dateISO]));
  const ws=XLSX.utils.aoa_to_sheet(data); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Prices"); XLSX.writeFile(wb,"buildy.xlsx");
};

clearAllBtn.onclick=async()=>{ if(confirm("Clear all data?")){ entries=[]; await api.clear(); refresh(); } };
exportJSONBtn.onclick=()=>{ const blob=new Blob([JSON.stringify(entries,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='buildy.json'; a.click(); };
importJSONBtn.onclick=()=>{ const input=document.createElement('input'); input.type='file'; input.accept='.json'; input.onchange=e=>{ const file=e.target.files[0]; const reader=new FileReader(); reader.onload=async ev=>{ try{ entries=JSON.parse(ev.target.result); await api.save(entries); refresh(); }catch(err){alert("Invalid JSON");} }; reader.readAsText(file); }; input.click(); };

function refresh(){ renderEntries(); renderComparison(); buildFilters(); renderTrend(trendMaterial.value); updateStats(); }

// Initialize
async function init(){ entries=await api.get(); renderSuppliers(); refresh(); renderMap(); }
init();

// Leaflet Map
let map=null;
function renderMap(){
  map=L.map('map').setView([53.35,-6.26],13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
  SUPPLIERS.forEach(s=>{ L.marker([s.lat,s.lng]).addTo(map).bindPopup(s.name); });
}
</script>
</body>
</html>
